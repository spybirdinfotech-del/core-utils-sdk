name: Build & Distribute (firebase All Flavors)

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:

  # --------------------------------------------------
  # ANDROID BUILD (dev / staging / production)
  # --------------------------------------------------
  build_android:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    # RUN FLAVORS ONE-BY-ONE → NO CANCELLATION
    strategy:
      max-parallel: 1
      matrix:
        flavor: [ dev, staging, production ]

    env:
      GRADLE_WATCH_FREQUENCY: "0"
      GRADLE_OPTS: "-Dorg.gradle.vfs.watch=false"

    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.7'

      - name: Install dependencies
        run: flutter pub get

      # ---- ANDROID APK ----
      - name: Build APK (${{ matrix.flavor }})
        run: |
          flutter build apk --flavor ${{ matrix.flavor }} --release --no-tree-shake-icons
        timeout-minutes: 30

      # ---- ANDROID AAB ----
      - name: Build AAB (${{ matrix.flavor }})
        run: |
          flutter build appbundle --flavor ${{ matrix.flavor }} --release --no-tree-shake-icons
        timeout-minutes: 30

      - name: Install Firebase Tools
        run: npm install -g firebase-tools

      # ---- UPLOAD APK TO FIREBASE ----
      - name: Upload APK to Firebase App Distribution (${{ matrix.flavor }})
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        run: |
          if [ "${{ matrix.flavor }}" = "dev" ]; then
            APP_ID="${{ secrets.FIREBASE_APP_ID_ANDROID_DEV }}"
          elif [ "${{ matrix.flavor }}" = "staging" ]; then
            APP_ID="${{ secrets.FIREBASE_APP_ID_ANDROID_STAGING }}"
          else
            APP_ID="${{ secrets.FIREBASE_APP_ID_ANDROID_PRODUCTION }}"
          fi
          
          if [ -z "$APP_ID" ]; then
            echo "ERROR: Firebase App ID is empty for flavor ${{ matrix.flavor }}"
            exit 1
          fi
          
          firebase appdistribution:distribute build/app/outputs/flutter-apk/app-${{ matrix.flavor }}-release.apk \
            --app "$APP_ID" \
            --release-notes "${{ matrix.flavor }} CI build" \
            --token "$FIREBASE_TOKEN"

      - name: Upload AAB as Artifact (${{ matrix.flavor }})
        uses: actions/upload-artifact@v4
        with:
          name: android-${{ matrix.flavor }}-build
          path: build/app/outputs/bundle/${{ matrix.flavor }}Release/app-${{ matrix.flavor }}-release.aab

  # --------------------------------------------------
  # iOS BUILD (dev / staging / production)
  # --------------------------------------------------
  build_ios:
    runs-on: macos-latest
    strategy:
      matrix:
        flavor: [dev, staging, production]
    env:
      FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.7'

      - name: Install dependencies
        run: flutter pub get

      - name: Build iOS app (no codesign) (${{ matrix.flavor }})
        run: flutter build ios --flavor ${{ matrix.flavor }} --release --no-codesign

      - name: Create unsigned IPA (${{ matrix.flavor }})
        run: |
          mkdir -p build/ios/ipa/Payload
          cp -r build/ios/iphoneos/Runner.app build/ios/ipa/Payload/
          cd build/ios/ipa
          zip -r Runner-${{ matrix.flavor }}.ipa Payload

      - name: Install Firebase Tools
        run: npm install -g firebase-tools

      - name: Upload IPA to Firebase App Distribution (${{ matrix.flavor }})
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        run: |
          # Map flavor → Firebase App ID
          if [ "${{ matrix.flavor }}" = "dev" ]; then
            APP_ID="${{ secrets.FIREBASE_APP_ID_IOS_DEV }}"
          elif [ "${{ matrix.flavor }}" = "staging" ]; then
            APP_ID="${{ secrets.FIREBASE_APP_ID_IOS_STAGING }}"
          else
            APP_ID="${{ secrets.FIREBASE_APP_ID_IOS_PRODUCTION }}"
          fi

          # Fail if secret is missing
          if [ -z "$APP_ID" ]; then
            echo "ERROR: Firebase App ID is empty for flavor ${{ matrix.flavor }}"
            exit 1
          fi

          firebase appdistribution:distribute build/ios/ipa/Runner-${{ matrix.flavor }}.ipa \
            --app "$APP_ID" \
            --release-notes "${{ matrix.flavor }} CI build" \
            --token "$FIREBASE_TOKEN"

      - name: Upload IPA as artifact (${{ matrix.flavor }})
        uses: actions/upload-artifact@v4
        with:
          name: ios-${{ matrix.flavor }}-build
          path: build/ios/ipa/Runner-${{ matrix.flavor }}.ipa

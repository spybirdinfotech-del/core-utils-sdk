name: Build & Distribute (Firebase All Flavors)

on:
  # Allows manual triggering from the GitHub Actions UI
  workflow_dispatch:
  # Triggers on pushes to the main branch
  push:
    branches:
      - main

jobs:
  # --------------------------------------------------
  # ANDROID BUILD & DISTRIBUTION (dev / staging / production)
  # --------------------------------------------------
  build_android:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    # RUN FLAVORS ONE-BY-ONE
    strategy:
      max-parallel: 1
      matrix:
        flavor: [ dev, staging, production ]

    env:
      GRADLE_WATCH_FREQUENCY: "0"
      GRADLE_OPTS: "-Dorg.gradle.vfs.watch=false"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.7' # Adjust to your desired version

      - name: Install dependencies
        run: flutter pub get

      # ---- ANDROID APK BUILD ----
      - name: üèóÔ∏è Build APK (${{ matrix.flavor }})
        run: |
          flutter clean
          flutter build apk --flavor ${{ matrix.flavor }} --release --no-tree-shake-icons
        timeout-minutes: 20

      - name: Install Firebase Tools
        run: npm install -g firebase-tools

      # ---- UPLOAD APK TO FIREBASE ----
      - name: Upload APK to Firebase App Distribution (${{ matrix.flavor }})
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        run: |
          # 1. Map flavor to the corresponding Firebase App ID secret
          if [ "${{ matrix.flavor }}" = "dev" ]; then
            APP_ID="${{ secrets.FIREBASE_APP_ID_ANDROID_DEV }}"
          elif [ "${{ matrix.flavor }}" = "staging" ]; then
            APP_ID="${{ secrets.FIREBASE_APP_ID_ANDROID_STAGING }}"
          else
            APP_ID="${{ secrets.FIREBASE_APP_ID_ANDROID_PRODUCTION }}"
          fi
          
          # 2. FAIL if the secret is missing (Safety Check)
          if [ -z "$APP_ID" ]; then
            echo "::error::ERROR: Firebase App ID is empty for flavor ${{ matrix.flavor }}. Check your GitHub Secrets."
            exit 1
          fi
          
          # 3. Distribute the APK
          APK_PATH="build/app/outputs/flutter-apk/app-${{ matrix.flavor }}-release.apk"
          
          firebase appdistribution:distribute "$APK_PATH" \
            --app "$APP_ID" \
            --release-notes "${{ matrix.flavor }} CI build" \
            --token "$FIREBASE_TOKEN"

      - name: Upload APK as Artifact (${{ matrix.flavor }})
        uses: actions/upload-artifact@v4
        with:
          name: android-${{ matrix.flavor }}-apk
          path: build/app/outputs/flutter-apk/app-${{ matrix.flavor }}-release.apk

  # --------------------------------------------------
  # iOS BUILD & DISTRIBUTION (dev / staging / production)
  # --------------------------------------------------
  build_ios:
    runs-on: macos-latest
    timeout-minutes: 90
    needs: build_android # Runs after Android is complete

    # RUN FLAVORS ONE-BY-ONE
    strategy:
      max-parallel: 1
      matrix:
        flavor: [dev, staging, production]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.35.7'

      - name: Install dependencies
        run: flutter pub get

      # ---- iOS BUILD (No Codesign) ----
      - name: Build iOS app (no codesign) (${{ matrix.flavor }})
        run: |
          flutter clean
          # Builds the iOS app for the platform (iphoneos) without signing
          flutter build ios --flavor ${{ matrix.flavor }} --release --no-codesign
        timeout-minutes: 20

      # ---- CREATE UNSIGNED IPA ----
      - name: Create unsigned IPA (${{ matrix.flavor }})
        run: |
          mkdir -p build/ios/ipa/Payload
          cp -r build/ios/iphoneos/Runner.app build/ios/ipa/Payload/
          cd build/ios/ipa
          # Zips the payload to create the IPA file
          zip -r Runner-${{ matrix.flavor }}.ipa Payload

      - name: Install Firebase Tools
        run: npm install -g firebase-tools

      # ---- UPLOAD IPA TO FIREBASE ----
      - name: Upload IPA to Firebase App Distribution (${{ matrix.flavor }})
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        run: |
          # 1. Map flavor to the corresponding Firebase App ID secret
          if [ "${{ matrix.flavor }}" = "dev" ]; then
            APP_ID="${{ secrets.FIREBASE_APP_ID_IOS_DEV }}"
          elif [ "${{ matrix.flavor }}" = "staging" ]; then
            APP_ID="${{ secrets.FIREBASE_APP_ID_IOS_STAGING }}"
          else
            APP_ID="${{ secrets.FIREBASE_APP_ID_IOS_PRODUCTION }}"
          fi

          # 2. FAIL if the secret is missing (Safety Check)
          if [ -z "$APP_ID" ]; then
            echo "::error::ERROR: Firebase App ID is empty for flavor ${{ matrix.flavor }}. Check your GitHub Secrets."
            exit 1
          fi

          # 3. Distribute the IPA
          IPA_PATH="build/ios/ipa/Runner-${{ matrix.flavor }}.ipa"
          
          firebase appdistribution:distribute "$IPA_PATH" \
            --app "$APP_ID" \
            --release-notes "${{ matrix.flavor }} CI build" \
            --token "$FIREBASE_TOKEN"

      - name: Upload IPA as artifact (${{ matrix.flavor }})
        uses: actions/upload-artifact@v4
        with:
          name: ios-${{ matrix.flavor }}-ipa
          path: build/ios/ipa/Runner-${{ matrix.flavor }}.ipa